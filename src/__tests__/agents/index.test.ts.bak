import { describe, it, expect } from "vitest";
import {
  builtinAgents,
  enforcer,
  architect,
  orchestrator,
  bugTriageSpecialist,
  codeReviewer,
  securityAuditor,
  refactorer,
  testArchitect,
} from "../../agents/index.js";
import type { AgentConfig } from "../../agents/types.js";

describe("Agent Index Registry", () => {
  describe("Builtin Agents Registry", () => {
    it("should export a valid builtinAgents registry", () => {
      expect(builtinAgents).toBeDefined();
      expect(typeof builtinAgents).toBe("object");
      expect(builtinAgents).not.toBeNull();
    });

    it("should contain all specialized agents", () => {
      const expectedAgents = [
        "enforcer",
        "architect",
        "orchestrator",
        "bug-triage-specialist",
        "code-reviewer",
        "security-auditor",
        "refactorer",
        "test-architect",
      ];

      expectedAgents.forEach((agentName) => {
        expect(builtinAgents).toHaveProperty(agentName);
      });

      expect(Object.keys(builtinAgents)).toBeGreaterThanOrEqual(8);
    });

    it("should have all agents as valid AgentConfig objects", () => {
      Object.values(builtinAgents).forEach((agent) => {
        expect(agent).toBeDefined();
        expect(typeof agent).toBe("object");
        expect(agent).toHaveProperty("name");
        expect(agent).toHaveProperty("model");
        expect(agent).toHaveProperty("description");
        expect(agent).toHaveProperty("mode");
        expect(agent).toHaveProperty("system");
        expect(agent).toHaveProperty("temperature");
      });
    });

    it("should have agents with correct names matching their keys", () => {
      Object.entries(builtinAgents).forEach(([key, agent]) => {
        expect(agent.name).toBeDefined();
        expect(agent.name.toLowerCase()).toBe(key.toLowerCase());
      });
    });

    it("should have agents configured appropriately", () => {
      Object.values(builtinAgents).forEach((agent) => {
        expect(["subagent", "primary"]).toContain(agent.mode);
      });
    });

    it("should have agents with consistent model configuration", () => {
      Object.values(builtinAgents).forEach((agent) => {
        expect(agent.model).toBe("opencode/grok-code");
      });
    });

    it("should have agents with appropriate temperature settings", () => {
      Object.values(builtinAgents).forEach((agent) => {
        expect(agent.temperature).toBeGreaterThanOrEqual(0.1);
      });
    });
  });

  describe("Individual Agent Exports", () => {
    it("should export all 8 individual agents", () => {
      expect(enforcer).toBeDefined();
      expect(architect).toBeDefined();
      expect(orchestrator).toBeDefined();
      expect(bugTriageSpecialist).toBeDefined();
      expect(codeReviewer).toBeDefined();
      expect(securityAuditor).toBeDefined();
      expect(refactorer).toBeDefined();
      expect(testArchitect).toBeDefined();
    });

    it("should have individual exports match registry entries", () => {
      expect(builtinAgents.enforcer).toBe(enforcer);
      expect(builtinAgents.architect).toBe(architect);
      expect(builtinAgents.orchestrator).toBe(orchestrator);
      expect(builtinAgents["bug-triage-specialist"]).toBe(bugTriageSpecialist);
      expect(builtinAgents["code-reviewer"]).toBe(codeReviewer);
      expect(builtinAgents["security-auditor"]).toBe(securityAuditor);
      expect(builtinAgents.refactorer).toBe(refactorer);
      expect(builtinAgents["test-architect"]).toBe(testArchitect);
    });

    it("should have all individual exports as valid AgentConfig objects", () => {
      const individualAgents = [
        enforcer,
        architect,
        orchestrator,
        bugTriageSpecialist,
        codeReviewer,
        securityAuditor,
        refactorer,
        testArchitect,
      ];

      individualAgents.forEach((agent) => {
        const config: AgentConfig = agent;
        expect(config).toBeDefined();
      });
    });
  });

  describe("Registry Integrity", () => {
    it("should have no duplicate agent names", () => {
      const names = Object.values(builtinAgents).map((agent) => agent.name);
      const uniqueNames = new Set(names);
      expect(uniqueNames.size).toBe(names.length);
    });

    it("should have no duplicate keys", () => {
      const keys = Object.keys(builtinAgents);
      const uniqueKeys = new Set(keys);
      expect(uniqueKeys.size).toBe(keys.length);
    });

    it("should have consistent naming between keys and agent names", () => {
      Object.entries(builtinAgents).forEach(([key, agent]) => {
        expect(agent.name.toLowerCase()).toBe(key.toLowerCase());
      });
    });

    it("should have all required AgentConfig properties", () => {
      const requiredProps = ["name", "model", "description", "mode", "system"];

      Object.values(builtinAgents).forEach((agent) => {
        requiredProps.forEach((prop) => {
          expect(agent).toHaveProperty(prop);
          expect(agent[prop as keyof AgentConfig]).toBeDefined();
          expect(agent[prop as keyof AgentConfig]).not.toBe("");
        });
      });
    });
  });

  describe("Agent Categories", () => {
    it("should include all framework core agents", () => {
      const coreAgents = ["enforcer", "architect", "orchestrator"];
      coreAgents.forEach((agentName) => {
        expect(builtinAgents).toHaveProperty(agentName);
      });
    });

    it("should include specialized agents", () => {
      const specializedAgents = [
        "bug-triage-specialist",
        "code-reviewer",
        "security-auditor",
        "refactorer",
        "test-architect",
      ];

      specializedAgents.forEach((agentName) => {
        expect(builtinAgents).toHaveProperty(agentName);
      });
    });
  });

  describe("Type Safety", () => {
    it("should maintain type safety across all exports", () => {
      // This test ensures TypeScript compilation would catch type errors
      const agents: Record<string, AgentConfig> = builtinAgents;

      Object.values(agents).forEach((agent) => {
        // Type assertions that would fail at compile time if types are wrong
        const name: string = agent.name;
        const model: string = agent.model;
        const description: string = agent.description;
        const mode: "primary" | "subagent" | "all" = agent.mode;
        const system: string = agent.system;

        expect(typeof name).toBe("string");
        expect(typeof model).toBe("string");
        expect(typeof description).toBe("string");
        expect(["primary", "subagent", "all"]).toContain(mode);
        expect(typeof system).toBe("string");
      });
    });
  });

  describe("Registry Completeness", () => {
    it("should export exactly the expected agents", () => {
      const expectedKeys = new Set([
        "enforcer",
        "architect",
        "orchestrator",
        "bug-triage-specialist",
        "code-reviewer",
        "security-auditor",
        "refactorer",
        "test-architect",
      ]);

      const actualKeys = new Set(Object.keys(builtinAgents));

      expect(actualKeys).toEqual(expectedKeys);
    });

});
