import { describe, it, expect, beforeEach, afterEach } from "vitest";
import { frameworkLogger } from "../framework-logger";
import * as fs from "fs";
import * as path from "path";

describe("Framework Logging File Persistence", () => {
  const logDir = path.join(process.cwd(), ".opencode", "logs");
  const logFile = path.join(logDir, "framework-activity.log");

  beforeEach(() => {
    if (fs.existsSync(logFile)) {
      fs.unlinkSync(logFile);
    }
  });

  afterEach(() => {
    if (fs.existsSync(logFile)) {
      fs.unlinkSync(logFile);
    }
  });

  it("should create log file and write entries", async () => {
    await frameworkLogger.log("test-persistence", "file write test", "success");

    expect(fs.existsSync(logFile)).toBe(true);

    const fileContent = fs.readFileSync(logFile, "utf-8");
    expect(fileContent).toContain("[test-persistence]");
    expect(fileContent).toContain("file write test");
    expect(fileContent).toContain("SUCCESS");
  });

  it("should append multiple log entries to file", async () => {
    await frameworkLogger.log("test-multi", "first action", "success");
    await frameworkLogger.log("test-multi", "second action", "info");
    await frameworkLogger.log("test-multi", "third action", "error");

    const fileContent = fs.readFileSync(logFile, "utf-8");
    const lines = fileContent.trim().split("\n");

    expect(lines.length).toBe(3);
    expect(lines[0]).toContain("first action");
    expect(lines[1]).toContain("second action");
    expect(lines[2]).toContain("third action");
  });

  it("should maintain log file format with timestamps", async () => {
    const beforeTime = Date.now();
    await frameworkLogger.log("test-format", "format test", "success");
    const afterTime = Date.now();

    const fileContent = fs.readFileSync(logFile, "utf-8");
    const logEntry = fileContent.trim();

    expect(logEntry).toMatch(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/);
    expect(logEntry).toContain("[test-format]");
    expect(logEntry).toContain("format test");
    expect(logEntry).toContain("SUCCESS");

    const timestampMatch = logEntry.match(/(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z)/);
    if (timestampMatch) {
      const logTime = new Date(timestampMatch[1]).getTime();
      expect(logTime).toBeGreaterThanOrEqual(beforeTime - 1000);
      expect(logTime).toBeLessThanOrEqual(afterTime + 1000);
    }
  });

  it("should create log directory if it doesn't exist", async () => {
    if (fs.existsSync(logDir)) {
      fs.rmSync(logDir, { recursive: true, force: true });
    }

    await frameworkLogger.log("test-dir", "directory creation test", "success");

    expect(fs.existsSync(logDir)).toBe(true);
    expect(fs.existsSync(logFile)).toBe(true);
  });
});