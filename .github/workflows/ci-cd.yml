name: StringRay Framework CI/CD

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Type checking
      run: npm run typecheck

    - name: Linting
      run: npm run lint

    - name: Security audit
      run: npm audit --audit-level moderate

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build framework
      run: npm run build:all

    - name: Run unit tests
      run: npm run test:unit

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test-unit

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build framework
      run: npm run build:all

    - name: Run integration tests
      run: npm run test:integration

  test-e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: test-integration

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build framework
      run: npm run build:all

    - name: Run E2E tests
      run: npm run test:e2e

  validate-framework:
    name: Framework Validation
    runs-on: ubuntu-latest
    needs: test-e2e

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build framework
      run: npm run build:all

    - name: Package framework
      run: npm pack

    - name: Test package installation
      run: |
        mkdir test-install
        cd test-install
        npm init -y
        npm install ../strray-ai-*.tgz
        node node_modules/strray-ai/scripts/postinstall.cjs

    - name: Validate framework deployment
      run: |
        cd test-install
        node node_modules/strray-ai/scripts/test:postinstall-config.js
        node node_modules/strray-ai/scripts/test:mcp-connectivity.js
        node node_modules/strray-ai/scripts/test:oh-my-opencode-integration.js

  deploy-validation:
    name: Deployment Validation
    runs-on: ubuntu-latest
    needs: validate-framework
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Build and package
      run: |
        npm run build:all
        npm pack

    - name: Deploy to test environment
      run: ./scripts/deploy-stringray-plugin.sh ci-deploy

    - name: Run deployment tests
      run: |
        cd ci-deploy
        node node_modules/strray-ai/scripts/test:mcp-connectivity.js
        node_modules/strray-ai/scripts/test:oh-my-opencode-integration.js
        node node_modules/strray-ai/scripts/test:postinstall-config.js

  version-management:
    name: Version Management & Publish
    runs-on: ubuntu-latest
    needs: deploy-validation
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'

    - name: Install dependencies
      run: npm ci

    - name: Build and test (pre-version)
      run: |
        npm run build:all
        npm run test:all

    - name: Deploy test (pre-version)
      run: ./scripts/deploy-stringray-plugin.sh ci-deploy-pre-version

    - name: Version bump
      run: npm version patch --no-git-tag-version --no-commit-hooks

    - name: Universal version management
      run: node scripts/universal-version-manager.js

    - name: Rebuild with new version
      run: npm run build:all

    - name: Final deployment test
      run: ./scripts/deploy-stringray-plugin.sh ci-deploy-final

    - name: Commit version updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "chore: automated version bump and standardization [ci skip]" || echo "No changes to commit"

    - name: Publish to NPM
      run: npm publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Create git tag
      run: |
        NEW_VERSION=$(node -p "require('./package.json').version")
        git tag "v$NEW_VERSION"
        git push origin "v$NEW_VERSION"
