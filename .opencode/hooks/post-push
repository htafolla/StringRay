#!/bin/bash
# StrRay Post-Processor post-push Hook
# Automatically triggers post-processor after post-push

# Get hook type from script name
HOOK_NAME=$(basename "$0")
COMMIT_SHA=""

if [ "$HOOK_NAME" = "post-commit" ]; then
  COMMIT_SHA=$(git rev-parse HEAD)
elif [ "$HOOK_NAME" = "post-push" ]; then
  # For push hooks, we need to parse the pushed refs from stdin
  while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" != "0000000000000000000000000000000000000000" ]; then
      COMMIT_SHA=$local_sha
      break
    fi
  done
else
  COMMIT_SHA=$(git rev-parse HEAD)
fi

if [ -z "$COMMIT_SHA" ]; then
  echo "Warning: Could not determine commit SHA for post-processor"
  exit 0
fi

# Get repository info
REPO="strray-framework/stringray"  # Placeholder for now
BRANCH=$(git rev-parse --abbrev-ref HEAD)
AUTHOR=$(git log -1 --pretty=format:'%an <%ae>')

# Get changed files
FILES=$(git diff --name-only HEAD~1 2>/dev/null || git diff --name-only --cached)

# Trigger post-processor asynchronously (don't block git operations)
(
  cd "$(dirname "$0")/../.." # Navigate to project root

  # Find the StrRay plugin in node_modules or current project (development)
  STRRAY_PLUGIN=""
  if [ -d "node_modules/strray-framework" ]; then
    STRRAY_PLUGIN="node_modules/strray-framework"
  elif [ -d "node_modules/@strray/strray-framework" ]; then
    STRRAY_PLUGIN="node_modules/@strray/strray-framework"
  elif [ -d "node_modules/oh-my-opencode/plugins/strray-framework" ]; then
    STRRAY_PLUGIN="node_modules/oh-my-opencode/plugins/strray-framework"
  elif [ -f "dist/postprocessor/PostProcessor.js" ]; then
    # Development mode - use current project
    STRRAY_PLUGIN="."
  fi

  if command -v node >/dev/null 2>&1 && [ -n "$STRRAY_PLUGIN" ]; then
    echo "üîç Found StrRay plugin at: $STRRAY_PLUGIN"
    echo "üìù Commit: $COMMIT_SHA, Branch: $BRANCH"

    # Call a separate script to avoid bash variable issues
    export COMMIT_SHA="$COMMIT_SHA"
    export REPO="$REPO"
    export BRANCH="$BRANCH"
    export AUTHOR="$AUTHOR"
    export STRRAY_PLUGIN="$STRRAY_PLUGIN"

    # Run the post-processor script
    node -e "
    (async () => {
      try {
        const plugin = process.env.STRRAY_PLUGIN;
        const { PostProcessor } = await import('./' + plugin + '/dist/postprocessor/PostProcessor.js');
        const { StrRayStateManager } = await import('./' + plugin + '/dist/state/state-manager.js');
        const { createSessionCoordinator } = await import('./' + plugin + '/dist/delegation/session-coordinator.js');
        const { createSessionCleanupManager } = await import('./' + plugin + '/dist/session/session-cleanup-manager.js');
        const { createSessionMonitor } = await import('./' + plugin + '/dist/session/session-monitor.js');

        const stateManager = new StrRayStateManager();
        const sessionCoordinator = createSessionCoordinator(stateManager);
        const cleanupManager = createSessionCleanupManager(
          stateManager,
          { defaultTtlMs: 86400000, cleanupIntervalMs: 300000 },
          null
        );
        const sessionMonitor = createSessionMonitor(
          stateManager,
          sessionCoordinator,
          cleanupManager,
          {}
        );

        const context = {
          commitSha: process.env.COMMIT_SHA,
          repository: process.env.REPO,
          branch: process.env.BRANCH,
          author: process.env.AUTHOR,
          files: [],
          trigger: 'git-hook'
        };

        console.log('üöÄ Post-processor triggered for commit:', context.commitSha);

        const pp = new PostProcessor(stateManager, sessionMonitor, {
          triggers: { gitHooks: false, webhooks: false, api: false },
          monitoring: { enabled: true, interval: 30000, timeout: 3600000 },
          autoFix: { enabled: false, confidenceThreshold: 0.8, maxAttempts: 3 },
          escalation: { manualInterventionThreshold: 2, rollbackThreshold: 3, emergencyThreshold: 5 },
          redeploy: { maxRetries: 3, retryDelay: 30000, backoffStrategy: 'exponential', canaryEnabled: true, canaryPhases: 3, canaryTrafficIncrement: 25, healthCheckTimeout: 60000, rollbackOnFailure: true },
          success: { successConfirmation: true, cleanupEnabled: true, notificationEnabled: true, metricsCollection: true }
        });

        await pp.initialize();
        await pp.executePostProcessorLoop(context);
        console.log('‚úÖ Post-processor completed successfully');
      } catch (error) {
        console.error('‚ùå Post-processor failed:', error.message);
      }
    })();
    "
  else
    echo "Warning: StrRay plugin not found or Node.js not available, skipping post-processor"
  fi
)

# Don't wait for background process
exit 0
